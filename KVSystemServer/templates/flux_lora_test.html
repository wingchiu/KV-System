<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux GGUF Lora Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .processing { background-color: #fff3cd; color: #856404; }
        #output {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        #output img {
            max-width: 100%;
            height: auto;
        }
        .additional-info {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .additional-info h3 {
            margin-top: 0;
            color: #007bff;
            font-size: 1.1em;
        }
        .additional-info ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
        }
        .additional-info li {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Flux GGUF Lora Image Generator</h1>
    
    <div class="form-group">
        <label for="width">Width:</label>
        <input type="number" id="width" value="1280" min="64" max="2048">
        
        <label for="height">Height:</label>
        <input type="number" id="height" value="1024" min="64" max="2048">
        
        <label for="loraName">Lora Name:</label>
        <input type="text" id="lora" value="NCMocha.safetensors" placeholder="Enter Lora name">
        
        <label for="modelName">Model Name (UNET):</label>
        <input type="text" id="model" value="flux1-dev-Q4_0.gguf" placeholder="Enter model name">
        
        <label for="positivePrompt">Positive Prompt:</label>
        <textarea id="positive" rows="4" placeholder="Enter positive prompt">Create a vibrant and engaging advertisement for coffee, featuring a cozy café setting with a warm, inviting atmosphere. In the foreground, there should be a close-up of a steaming cup of Nescafé Gold, highlighting its rich, creamy texture. The background should depict a picturesque landscape with mountains and a clear blue sky, with hot air balloons floating in the distance, evoking a sense of adventure and relaxation. The Nescafé Gold product should be prominently displayed, with the tagline 'Nescafé Gold Expertly Crafted with Care' clearly visible. The overall composition should convey the message that Nescafé Gold is not just a beverage, but an experience that brings people together and creates memorable moments. The color palette should be warm and inviting, with a mix of earthy tones and bright accents to draw the viewer's eye to the key elements of the image.</textarea>
        
        <label for="negativePrompt">Negative Prompt:</label>
        <textarea id="negative" rows="4" placeholder="Enter negative prompt"></textarea>
        
        <label for="batchSize">Batch Size:</label>
        <input type="number" id="batch" value="1" min="1" max="10">

        <div class="additional-info">
            <h3>Additional Information</h3>
            <ul>
                <li>Steps: 22</li>
                <li>CFG: 1</li>
                <li>Sampler: euler</li>
                <li>Scheduler: simple</li>
                <li>CLIP Model: t5-v1_1-xxl-encoder-Q5_K_M.gguf</li>
                <li>VAE Model: ae.safetensors</li>
            </ul>
        </div>
        
        <button onclick="generateImages()" id="generate">Generate Images</button>
    </div>

    <div id="status"></div>
    <div id="output"></div>

    <script>
        async function generateImages() {
            const status = document.getElementById('status');
            const output = document.getElementById('output');
            const generateBtn = document.getElementById('generate');
            
            // Clear previous output
            status.textContent = 'Generating images...';
            output.innerHTML = '';
            generateBtn.disabled = true;
            
            try {
                const response = await fetch('/generate_flux_lora', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        width: 1024,
                        height: 768,
                        lora_name: document.getElementById('lora').value,
                        model_name: document.getElementById('model').value,
                        positive_prompt: document.getElementById('positive').value,
                        negative_prompt: document.getElementById('negative').value,
                        batch_size: parseInt(document.getElementById('batch').value)
                    })
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    status.className = 'success';
                    status.textContent = 'Images generated successfully!';
                    
                    if (!result.images || result.images.length === 0) {
                        throw new Error('No images received from server');
                    }
                    
                    console.log(`Received ${result.images.length} images`);
                    
                    // Display the generated images
                    result.images.forEach((imageData, index) => {
                        console.log(`Processing image ${index + 1}`);
                        const img = document.createElement('img');
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        img.style.marginBottom = '10px';
                        
                        try {
                            if (!imageData) {
                                throw new Error('Image data is empty');
                            }
                            
                            // Create a container for each image
                            const container = document.createElement('div');
                            container.style.marginBottom = '20px';
                            
                            // Create a loading message
                            const loadingMsg = document.createElement('div');
                            loadingMsg.textContent = `Loading image ${index + 1}...`;
                            container.appendChild(loadingMsg);
                            
                            // Set up image loading handlers
                            img.onerror = () => {
                                console.error(`Failed to load image ${index + 1}`);
                                loadingMsg.textContent = `Failed to load image ${index + 1}`;
                                loadingMsg.style.color = 'red';
                                
                                // Log image data info for debugging
                                console.log(`Image ${index + 1} data type:`, typeof imageData);
                                console.log(`Image ${index + 1} data length:`, imageData.length);
                                if (typeof imageData === 'string') {
                                    console.log(`Image ${index + 1} data preview:`, imageData.substring(0, 100));
                                }
                            };
                            
                            img.onload = () => {
                                console.log(`Successfully loaded image ${index + 1}`);
                                container.removeChild(loadingMsg);
                                status.textContent = 'Images generated and loaded successfully!';
                            };
                            
                            // Set the image source
                            if (imageData.startsWith('data:image')) {
                                img.src = imageData;
                            } else {
                                img.src = `data:image/png;base64,${imageData}`;
                            }
                            
                            container.appendChild(img);
                            output.appendChild(container);
                        } catch (error) {
                            console.error(`Error processing image ${index + 1}:`, error);
                            status.textContent += `\nError processing image ${index + 1}: ${error.message}`;
                        }
                    });
                } else {
                    status.className = 'error';
                    status.textContent = `Error: ${result.error || 'Unknown error occurred'}`;
                    if (result.steps) {
                        status.textContent += '\n\nDebug information:';
                        result.steps.forEach(step => {
                            status.textContent += `\n- ${step.name}: ${step.success ? 'Success' : 'Failed'}`;
                            if (step.error) {
                                status.textContent += ` (${step.error})`;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                status.className = 'error';
                status.textContent = `Error: ${error.message}`;
            } finally {
                generateBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
